---
layout: post
title: Linux. Работа с файлами и пользователями
permalink: linux-expanding-partition
tags: linux
comments: true
subtitle: Linux. Работа с файлами
summary:  Linux. Работа с файлами
is_navigate: true
cover_url: "/assets/images/articles/linux/part.png"
published: false
---

[Часть 1 - Linux. Хранение информации](https://lexusalex.ru/linux-Information-storage)

Основная абстракция linux - все есть файл, что позволяет использовать один интерфейс для работы с
любыми объектами системы через файлы. Любой объект в linux имеет своего владельца, то есть пользователя.

Классический механизм разграничения прав доступа в linux представляет из себя объекты, то есть файлы доступ к которым разграничивается и
субъекты, то есть пользователи доступ которых разграничивается.

О субъектах сейчас и пойдет речь.

Каждый пользователь характеризуется следующими обязательными параметрами :
1. Уникальное имя пользователя
2. UID - уникальный идентификатор пользователя
3. GID - уникальный идентификатор группы пользователя

и некоторыми необязательными, но о них позже.

### Пользователи

Пользователи могут хранится в двух хранилищах :
1. Локальное (автономное) ("Из коробки" в файлах)
2. Сетевое (NIS, LDAP)

Пользователи могут быть двух типов :
1. Системные ("псеводо") пользователи.
2. Реальные пользователи.

Исторически сложилось что локально пользователи в системе хранятся в двух таблицах (файлах), где каждый пользователь представлен одной строкой.

#### /etc/passwd

`/etc/passwd` - это системный файл паролей, где записаны его параметры в 7 полях разделенных символом ` : ` в следующем порядке :

Файл доступен для чтения всем.

1. name

    Имя пользователя для входа в систему.
    
    Символьное имя пользователя которое соответствует его числовуому идентификатору.
    
    - регулярное выражение которое соответсвует символам которые могут быть в имени пользователя `[a-z_][a-z0-9_-]*[$]?`
    - имена пользователей могут быть длиной не более 32 символов.
    
    *В старых версиях unix существовало ограничение на длину логина в 8 символов*
2. passwd 

    Зашифрованный пароль пользователя.
    
    По историческим причинам вся информация о пользователе включая зашифрованный пароль хранится в открытом файле для чтения `/etc/passwd`.
    В связи в этим вознили проблемы безопасности. В противостояние этому был разработан файл [теневой файл паролей](/etc/shadow) `/etc/shadow` в котором хранится вся конфидициальная информация пользователя.
    
    В современных версиях linux при включенном режиме "теневых паролей" это поле игнорируется и содержит символ `x`, хотя может содержать
    любую символьную строку, а зашифрованный пароль хранится в файле теневых паролей.
    
    У пользователя пароля может не быть.
3. UID

    Числовой идентификатор пользователя. 
    
    Система руководствуется в первую очередь имеено идентификатором, а не именем пользователя.
    
    Их диапазон может быть разным в зависимости от типа пользователя и операционной системы.
    
    Для многих системных служб номера идентификаторов зарезервированы.
    
    Существуют два специальных правила присвоения идентификаторов:
    - 0 для root
    - 65534 для nobody
    
    *Пользователь nobody не может являтся владельцем не одного файла в системе*
    
    В остальном система не накладывает на присвоение никаких ограничений.
    
    *В системе может быть несколько пользователей с одним UID, но использовать такую возможность не рекомендуется*
4. GID

    Для более гибкого разграничения прав доступа существуют группы.
    
    GID - это числовой идентификатор первой из групп в которую входит пользователь.
    Дальнейшая принадлежность пользователя к группам определена в системном файле групп `/etc/group/`
    
5. GECOS
    
    Необязательный комментарий для ученой записи. Определенного формата в современных системах нет, но могут быть заполнены следующие опции
    - Полное имя пользователя
    - адрес офиса или домашний адрес 
    - рабочий телефон 
    - домашний телефон
    
6. dir

    Домашний каталог пользователя
    
7. shell

    Оболочка пользователя для входа в систему. 
    Существуют особые "оболочки" которые запрещают пользоателю заходить в систему :
    
    - `/usr/sbin/nologin` - выдает сообщение "This account is currently not available."
    - `/bin/false` - просто запрещает вход в систему
    
Примеры : 
- `root:x:0:0:root:/root:/bin/bash` 
- `speech-dispatcher:x:120:29:Speech Dispatcher,,,:/var/run/speech-dispatcher:/bin/false`

##### Диапазон UID и GID

Диапазон UID и GID указывается в конфигурационном файле `/etc/login.defs`

Условно идентификаторы UID и GID делят на группы для обычных и системных пользователей.

Диапазон UID и GID значений по умолчанию для обычных пользователей которые используют программы `useradd` , `groupadd` , `newusers` :

- UID_MIN = 1000
- UID_MAX = 60000
- GID_MIN = 1000
- GID_MAX = 60000

Диапазон UID и GID значений по умолчанию для системных пользователей и служб используемых в программах `useradd` и `newusers`:

- SYS_UID_MIN = 101
- SYS_UID_MAX = UID_MIN - 1
- SYS_GID_MIN = 101
- SYS_GID_MAX = GID_MIN - 1

Максимальное значение идентификатора : 65534

##### root

Сложились ряд рекомендаций как работать с этим привелигерованным пользователем :

1. Не следует работать от имени этого пользователя ежедневно, работайте от не привелигерованного пользователя.
2. Для выполнения разовых администативных задач повышайте привелегии с помощью `sudo`
3. Сделать невозможным вход под учетной записью root в интерактивном режиме.

https://interface31.ru/tech_it/2019/12/linux-nachinayushhim-chast-6-upravlenie-pol-zovatelyami-i-gruppami.html

#### /etc/shadow

`/etc/shadow` - теневой файл паролей. Нужен для хранения пароля и некой другой закрытой информации пользователя.

Здесь параметры пользователя записаны в 9 полях разделенных символом ` : ` в следующем порядке : 

1. name
    Имя пользователя. Поле должно содержать правльное имя пользователя которое существует в файле `/etc/passwd`.
2. passwd
    Пароль пользователя в зашифрованном виде. 
    *Если поле содержит `!` или `*` это значит, что пользователь не может использовать это пароль, но может войти в
    систему под другими паролями*
    
    Возможны варианты что поле будет пустым.
    Поле пароля может начинаться в `!` это говорит о том что пароль заблокирован. Последующие символы и будут представлять пароль пользователя
3. latching
    Дата последней смены пароля в днях начиная с 1 января 1970 года.
    
    - Значение 0 имеет специальное значение, говорит о том что пользоатель должен сменить пароль при следующем входе в систему.
    - Пустое значение обозначает, что проверка устаревания пароля выключена.
4. min
    Минимальный срок действия пароля в днях, через указанное количество которых пользователи
    должны сменить пароль.
    
    - Значение 0 или пустое отключают минимальный срок действия пароля
5. max
    Максимальный срок действия пароля, по просшедствии которого пользователь должен сменить пароль.
    
    - Пустое значение обозначает что у пароля нет максимального срока действия, нет периода предупреждения и
      нет периаода неактивности пароля.
6. warn
    Количество дней до устаревания пароля во время которых пользователю выдаётся предупреждение.
    
    Пустое значение поля и 0 отключают период предупреждения о пароле.
    
7. inactive
    Количество дней после устаревания пароля  во время которых пароль всё ещё принимается 
    (и пользователь должен обновить свой пароль при следующем входе).
    
    После устаревания пароля и истечения этого периода устаревания вход с текущим 
    паролем становится невозможным.
    
    Пустое значение поля означает, что период неактивности отсутствует.
8. expire
    Дата истечения срока действия учётной записи. Поле не имеет никакого отношения в паролям

9. flag
    Это поле зарезервировано для использования в будущем.

<img src="images/articles/linux/users/ages.png" alt="Временная диаграмма">

Примеры : 
- `nvidia-persistenced:*:17614:0:99999:7:::`

Эти таблицы между собой взаимосвязаны их используют различные утилиты.

### Группы

Для более гибкого управления пользователями нужны группы. Пользователь может состоять в нескольких группах.

Список групп как и в случае с пользователями так же хранится в файлах.

*При создании пользователя в linux ему создается одноименная группа*

*Первоначально принадлежность к пользователя к группе было динамическим, нужно было предъявить пароль.
Потом членство в группах стало статическим и потребность в использоваонии пароля отпало.

Группы пользователей хранятся построчно в файле `/etc/group/` и `/etc/gshadow/` точно так же как и пользователи.

#### /etc/group/

Поля файла имеют следующий формат :

1. name group
2. passwd
    Когда у группы существовал пароль, но он точно так же перешел приватный файл `/etc/gshadow/`
3. GID
4. users group
    Список членов
    Если пользователь входит только в свою одноименную группу, в этом поле он не указывается.

#### /etc/gshadow/

Поля файла имеют следующий формат :

1. namegroup
2. passwd
3. users admin
    Администраторы группы, у которых особая роль, они могут изменять список членов группы
4. users group


Заблокировать учетную запись
passwd -l prizrak
passwd: информация об истечении срока действия пароля изменена.
Будет добавлен ! знак в хешу пароля

Разблокировать уч запись
passwd -u prizrak

### Утилиты для манипулирования учетными записями

~~~bash
dpkg -L passwd | grep /usr/sbin/ | sort
/usr/sbin/chgpasswd
/usr/sbin/chpasswd
/usr/sbin/cpgr
/usr/sbin/cppw

/usr/sbin/groupadd создание группы
/usr/sbin/groupdel - удаление группы
/usr/sbin/groupmod - модификация группы
/usr/sbin/grpck - проверка целостности групп
/usr/sbin/grpconv - конвертор из старого в новое хранилище
/usr/sbin/grpunconv - конвертор из старого в новое хранилище
/usr/sbin/newusers
/usr/sbin/pwck - проверка на корректность файлов passwd и shadow

/usr/sbin/pwconv - конвертор из публичной части в закрытую
/usr/sbin/pwunconv - конвертор из закрытой части в публичную

/usr/sbin/useradd - создать пользователя
/usr/sbin/userdel - удалить пользователя
/usr/sbin/usermod - изменить пользователя

/usr/sbin/vigr
/usr/sbin/vipw

dpkg -L passwd | grep /usr/bin/ | sort
/usr/bin/chage - смена возрастов паролей
/usr/bin/chfn
/usr/bin/chsh
/usr/bin/expiry
/usr/bin/gpasswd - админимтаторы могут добавить в группу
/usr/bin/passwd
~~~

### Создание пользователя

Рекомендуется создавать пользоваетля командой `adduser`, нежели `useradd`

adduser
deluser
addgroup
delgroup
Обычный пользователь


centos

### Профиль по умолчанию

<img src="images/articles/linux/users/profile_user.png" alt="Профиль пользователя">

Копируются они при создании пользовтеля
/etc
/etc/skel/ шаблон с которого все копируется
$HOME

ссылка на одну команду 

ls -la /usr/sbin/useradd /usr/sbin/adduser
lrwxrwxrwx. 1 root root      7 ноя  9 02:05 /usr/sbin/adduser -> useradd
-rwxr-xr-x. 1 root root 241752 ноя  9 02:05 /usr/sbin/useradd



Вот теперь мы подошли к основополагающему понятию файловой системы в linux - это фаил. 

Файлы в linux различают по их типу :

1. Обычный файл (regular file)
2. Каталог (directory)
3. Символическая ссылка (symbolic link)
4. Файл устройства (device file)
5. Именованный канал (named pipe)
6. Сокет (socket)

Как мы выяснили ранее метаданные (атрибуты) файла хранятся в индексном дескрипторе, так же там хранятся дисковые блоки файла, который есть у каждого файла.
Набор атрибутов файла зависит от его типа.

### Тип фаил (Regular file) (-)

Файл - это именованная область данных на внешнем носителе. Фаил может содержать любую
пользовательскую информацию в виде набора байт при этом операционная система не накладывает
никаких ограничений на содержимое.

Счетчик имен файла.
Жесткая ссылка . Разные имена могут быть только в той же файловой системе что и сами файлы


### Механизм разграничения доступа

Теперь поговорим об объектах в классическом смысле.

Доступ к файлу с точки зрения пользователя может осуществлять :

1. Владелец
2. Группа-владелец
3. Все остальные

Операции с файлом :
1. Чтение
2. Запись
3. Запуск (исполнение)

С целью разрешения доступа к объекту были введены базовые разрешения

1. R - Read
2. W - Write
3. X - eXecute

Но этих базовых разрешений бывает мало, поэтому иногда требуются дополнительные атрибуты, они нужны в том случае если
не хватает базовых. 
1. S - Set (SUID, SGID)
2. T - STicky (write) запись в рамках

### Режим доступа

Он формируется из базовых разрешение и дополнительных атрибутов.

Эти правила действуют для трех групп каждого из субъектов

<img src="images/articles/linux/files/access-mode.png" alt="Профиль пользователя">

1. SUID SGID T Дополнительные атрибуты
2. Владелец rwx
3. Группа-владелец rwx
4. Все остальные rwx

### Представление

--- rwx rwx rwx
1. Двоичное   --- 111 111 111
2. Десятичная --- 421 421 421
3. Итоговая (восьмиричное)  777

chmod u+r,g-w,o+x text.file
chmod u+r,g=,o= text.file

### SUID SGID T

ls -l /usr/bin/passwd -rwsr-xr-x - бит передачи полномочий s 
на самом деле программа выполнениятся от лица владельца файла

Передача полномочий пользователя или группы пользователя
find /bin /sbin /usr/bin /usr/sbin -perm /u+s -ls Список команд с доп атрибутами

Липучка Т работает относительно каталогов
Запись в каталог это права записать туда файлы
Проблема с общими каталогами
ls -ld /tmp/
drwxrwxrwt 17 root root 12288 май  6 17:55 /tmp/

find / -perm /+t -ls
Разрешеает записывать в каталого только тем пользователям которые этими файлами владеет

### Выполнения файла
Execute право на вход в каталог.

### Атрибуты файла

1. Идентификатор устройства на котором расположен файл
2. Номер inode
3. Права доступа
4. Кол-во жёстких ссылок
5. ID пользователя-владельца файла
6. ID группы-владельца файла
7. ID устройства (если это спец. файл)
8. Полный размер в байтах
9. размер блока ввода-вывода файловой системы
10. Кол-во выделенных блоков по 512Б
11. Время последнего доступа
12. Время последнего изменения
13. Время последней смены состояния


http://ru.manpages.org/stat/2


### Тип директория

Служебный файл, его содержимое волнует ос.

Список имен других файлов

. сам каталог
.. его родитель

### Тип символьная ссылка

Для ссылок на файл

### Тип именованный канал

IPC средство межпроцессное взаимодействие
В нем нет данных, в нем есть статическая информация.
Нужен для общения программ находящихся в разных процессах.
Общение только в одну сторону!
init halt reboot poweroff
halp перезагрузка

### Тип cокет

Обшение в обе стороны

syslogd cron cups

Пока речь о локальном сокете

Это все носит название UFS